import { useState } from "react";
import axios from "axios";

export default function useAuditCache() {
  const [auditCache, setAuditCache] = useState([]);

  const refreshAudit = async (productId, locationId) => {
    const res = await axios.get(
      `${process.env.REACT_APP_API_URL}/api/audit-logs/latest`,
      { params: { productId, locationId } }
    );
    setAuditCache(res.data);
  };

  return { auditCache, refreshAudit };
}

import useAuditCache from "../hooks/useAuditCache";

const { auditCache, refreshAudit } = useAuditCache();

const handleMouseEnter = async (e, termKey, type) => {
  const [productId, locationId] = selectedKey.split("@");

  // ðŸ”¥ Always refresh before tooltip
  await refreshAudit(productId, locationId);

  const latestAudit = auditCache.find(
    a => a.column === termKey && a.where_condition === type
  );

  if (!latestAudit) return;

  setTooltipData({
    visible: true,
    user: latestAudit.userid,
    before: latestAudit.values_before,
    after: latestAudit.values_after,
    time: new Date(latestAudit.timestamp).toLocaleString(),
    x: e.clientX,
    y: e.clientY
  });
};


Worksheet.jsx (FIXED)
axios.post("/publishForecastData", body)
  .then(() => {
    refreshAudit(productId, locationId); // âœ… shared hook
  });





