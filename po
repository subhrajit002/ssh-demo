public Map<LocalDate, Double> avgDailySales(
        String productId,
        String locationId,
        LocalDate startDate,
        int duration
) {

    Map<LocalDate, Double> response = new LinkedHashMap<>();

    if (productId == null || locationId == null || startDate == null || duration <= 0) {
        return response;
    }

    String sql = "SELECT * FROM " + historic_sales +
            " WHERE product_id = ? AND location_id = ? AND type = '1'";

    Map<String, Object> row;
    try {
        row = jdbcTemplate.queryForMap(sql, productId, locationId);
    } catch (EmptyResultDataAccessException e) {
        return response;
    }

    // -------- BASE DATE (TERM1 START) --------
    Object dateObj = row.get("date");
    if (dateObj == null) {
        return response;
    }

    LocalDate baseDate;
    if (dateObj instanceof java.sql.Date) {
        baseDate = ((java.sql.Date) dateObj).toLocalDate();
    } else if (dateObj instanceof LocalDate) {
        baseDate = (LocalDate) dateObj;
    } else {
        return response;
    }

    long daysDiff = ChronoUnit.DAYS.between(baseDate, startDate);
    if (daysDiff < 0) {
        return response;
    }

    int termIndex = (int) (daysDiff / 7) + 1;
    int dayOffset = (int) (daysDiff % 7);

    if (termIndex > 104) {
        return response;
    }

    double totalSales = 0.0;
    int daysCounted = 0;

    int currentTerm = termIndex;
    int currentDayOffset = dayOffset;

    // -------- ACCUMULATE SALES --------
    while (daysCounted < duration && currentTerm <= 104) {

        Object termObj = row.get("term" + currentTerm);
        if (!(termObj instanceof Number)) {
            break;
        }

        double weeklySales = ((Number) termObj).doubleValue();
        double perDaySales = weeklySales / 7.0;

        for (int d = currentDayOffset; d < 7 && daysCounted < duration; d++) {
            totalSales += perDaySales;
            daysCounted++;
        }

        currentTerm++;
        currentDayOffset = 0;
    }

    if (daysCounted == 0) {
        return response;
    }

    double avgDailySales = totalSales / daysCounted;

    // -------- FINAL RESPONSE --------
    for (int i = 0; i < daysCounted; i++) {
        response.put(startDate.plusDays(i), avgDailySales);
    }

    return response;
}
